# Frontend Specification - React Router 7 with Native SSR

## Overview
Server-side rendered React stocks application using React Router 7's native SSR support that fetches stock data from Google's Gemini API using route loaders.

## Architecture
- **Framework**: React with React Router 7 (Remix merged)
- **Routing**: React Router 7 with native SSR and data loading
- **Port**: 3000 (React Router 7 dev server)
- **Data Source**: Google Gemini API (triggered by expired cache visits)
- **Content Refresh**: Background refresh triggered on expired cache access
- **Build**: React Router 7 production build with SSR

## Routes (React Router 7)

### / (Home Route)
- **Component**: HomePage
- **Purpose**: Displays list of stock symbols
- **Data**: Static list (no loader needed)
- **Features**: Plain text stock symbol list, navigation to individual articles

### /stock/:symbol (Stock Article Route)
- **Component**: StockPage
- **Loader**: Fetches article data from cache only
- **Purpose**: Displays individual stock article
- **Data**: Retrieved via useLoaderData() hook
- **Features**: Article content (if available), stock info, back to home navigation
- **Empty State**: Shows nothing if loader returns null
- **Error**: 404 component for non-existent stock symbols


## File Structure
```
apps/
  stocks/
    package.json
    react-router.config.ts
    app/
      root.tsx
      routes.ts
      routes/
        _index.tsx
        stock.$symbol.tsx
      components/
        Layout.tsx
      services/
        geminiService.ts
        cacheService.ts
    .cache/
      articles/
        # Cached article files (e.g., AAPL.json)
    .gitignore
```

## Component Structure

### root.tsx (Root Layout)
- React Router 7 root component
- Global layout and providers
- Outlet for route content
- Error boundaries

### routes/_index.tsx (HomePage)
- Stock symbol list display
- Plain text list of stock symbols
- Link components to individual stock articles
- No loader needed (static data)

### routes/stock.$symbol.tsx (StockPage)
- **Loader function**: Fetches article data from cache/Gemini API
- **Component**: Displays article content using useLoaderData()
- Stock information header
- Article text with proper formatting
- Back navigation
- Empty state handling when loader returns null

### components/Layout.tsx (Shared Layout)
- Common header/footer structure
- Navigation components
- Reusable layout components

## Data Structure
- **Stock Symbols**: Static array of stock symbols
- **Article Content**: Generated by Gemini API during SSR and cached locally
- **Stock Info**: Real-time stock information fetched via Gemini API during SSR
- **Cache**: File-based cache for article content

## Dependencies
- react: UI library
- react-dom: DOM rendering
- @react-router/dev: React Router 7 development tools
- @react-router/node: React Router 7 Node.js adapter
- react-router: React Router 7 core
- typescript: Type checking
- @google/genai: Gemini API client (v2)
- react-markdown: Markdown rendering component
- basic-auth: HTTP basic authentication middleware

## Scripts
- `npm run dev`: React Router 7 development server with SSR
- `npm run build`: Production build
- `npm run start`: Production server

## React Router 7 Configuration
- react-router.config.ts: Main configuration file
- app/root.tsx: Root layout component
- app/routes.ts: Route definitions
- SSR enabled by default with route loaders

## Data Loading (React Router 7 Loaders)
- **Route Loaders**: Data fetching functions exported from route files
- **Server-side execution**: Loaders run on server during SSR
- **Client-side navigation**: Loaders called automatically via fetch on navigation
- **useLoaderData()**: Hook to access loader data in components
- **Cache-first strategy**: Check cache before calling Gemini API
- **Automatic serialization**: Data automatically passed between server and client

## Caching Strategy
- **Implementation**: Custom file-based cache service
- **Cache Location**: `.cache/articles/` directory
- **Cache Key**: Stock symbol (e.g., `AAPL.json`)
- **Cache Duration**: 10 minutes
- **Cache Flow in Route Loaders**:
  1. Loader checks if cached article exists for symbol
  2. If exists and not expired (< 10 minutes), return cached data
  3. If exists but expired (> 10 minutes), return old cached data AND trigger background refresh
  4. If not exists, return null and show empty state
  5. Never call API synchronously from route loaders
- **Content Generation**: Background refresh triggered when expired content is accessed

## Gemini Integration (v2)
- **API Key**: Stored in environment variables
- **Model**: Uses gemini-2.0-flash model with Google Search tools
- **Usage Pattern**:
  ```typescript
  import { GoogleGenAI } from "@google/genai";
  
  const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
  const response = await ai.models.generateContent({
    model: "gemini-2.0-flash",
    contents: [prompt],
    config: {
      tools: [{googleSearch: {}}],
    },
  });
  const content = response.text;
  ```
- **React Router 7 Integration**:
  - Route loaders read from cache and trigger background refresh if expired
  - Data automatically serialized between server and client
  - Content refreshed in background when expired content is accessed
- **Google Search Integration**: 
  - Real-time web search for current stock data
  - Grounding metadata available for accuracy
- **Content Format**: Gemini generates articles in Markdown format for proper rendering
- **Article Focus**: Recent news, price trends, and market context (last 7 days)
- **Error Handling**: Return null from loader if no cache exists

## Content Generation
- **Implementation**: Background refresh triggered by expired cache access
- **Integration Point**: Route loaders trigger background jobs
- **Process**: 
  1. User visits stock page with expired cache (> 10 minutes old)
  2. Route loader returns old cached content immediately
  3. Route loader triggers background refresh job for that specific stock
  4. Background job calls Gemini API to generate fresh content
  5. Background job updates cache with new content
  6. Next visit to the same stock will have fresh content
- **Cache TTL**: 10 minutes per stock article
- **User Experience**: Always fast page loads with cached content, fresh content appears on subsequent visits after background refresh completes

## Article Rendering
- **Markdown Support**: Articles generated by Gemini in Markdown format
- **React Component**: Uses `react-markdown` library for rendering
- **Features**: Proper headers, lists, bold text, and formatting
- **Integration**: Replaces custom HTML formatting with native Markdown rendering
- **Benefits**: Better typography, consistent formatting, and easier content management

## Authentication
- **Basic Auth**: HTTP basic authentication protects the entire site
- **Implementation**: Node.js basic-auth middleware in entry.server.tsx
- **Credentials**: Username and password stored in environment variables
- **Scope**: All routes protected (/, /stock/:symbol, and catch-all)
- **Response**: 401 Unauthorized with WWW-Authenticate header for invalid credentials

## Environment Variables
- `GEMINI_API_KEY`: Google Gemini API key
- `BASIC_AUTH_USER`: Username for basic authentication
- `BASIC_AUTH_PASS`: Password for basic authentication
- Set in .env file at project root

## Styling
- CSS modules or styled-components
- Responsive design
- Simple list styling for stock symbols
- Typography for article readability
- Navigation components
- Mobile-friendly layout